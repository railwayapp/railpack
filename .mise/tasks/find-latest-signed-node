#!/usr/bin/env bash
# Description: Find the latest Node.js version that has GPG signature available

set -euo pipefail

echo "Fetching Node.js release index..."
releases=$(curl -s https://nodejs.org/dist/index.json)

echo "Checking releases for GPG signatures..."
echo

latest_signed=""
count=0

# Parse JSON and check each version
while IFS= read -r version; do
  # Check if SHASUMS256.txt.asc exists for this version
  if curl -sf -I "https://nodejs.org/dist/${version}/SHASUMS256.txt.asc" > /dev/null 2>&1; then
    echo "✓ ${version} has GPG signature"
    if [[ -z "$latest_signed" ]]; then
      latest_signed="$version"
    fi
  else
    echo "✗ ${version} missing GPG signature"
  fi

  # Only check first 20 versions to avoid too many requests
  count=$((count + 1))
  if [[ $count -ge 20 ]]; then
    break
  fi
done < <(echo "$releases" | jq -r '.[].version')

echo
if [[ -n "$latest_signed" ]]; then
  echo "Latest Node.js version with GPG signature: $latest_signed"
  echo
  echo "Update NODE_VERIFY_BEFORE to: ${latest_signed#v}"
else
  echo "No GPG-signed versions found in recent releases"
fi
